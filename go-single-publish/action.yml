name: "go-single-publish"
description: "Publishes a single go binary to the container registry built from a dockerfile"
author: "Zak Shearman"
inputs:
  registry:
    description: "The name of the container registry to publish to (e.g. ghcr.io)"
    default: "ghcr.io"
  registry-username:
    description: "The username to use for the container registry"
    default: ${{ github.repository_owner }}
  registry-password:
    description: "The password to use for the container registry"
    required: true

  docker-image-name:
    description: "The name of the docker image to publish (e.g. emortalmc/mc-player)"
    default: ${{ github.repository }}


runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Login to container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build and push
      uses: docker/build-push-action@v4

      env:
        DOCKER_IMAGE_NAME: ${{ inputs.registry }}/${{ inputs.docker-image-name }}

      with:
        context: .
        file: ./Dockerfile
        push: true
        platforms: linux/amd64,linux/arm64
        cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:latest
        cache-to: type=inline
        tags: |
          ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          ${{ env.DOCKER_IMAGE_NAME }}:latest